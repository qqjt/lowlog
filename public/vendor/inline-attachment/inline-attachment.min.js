!function(e,t){"use strict";var a=function(e,t){this.settings=a.util.merge(e,a.defaults),this.editor=t,this.filenameTag="{filename}",this.lastValue=null};a.editors={},a.util={merge:function(){for(var e={},t=arguments.length-1;t>=0;t--){var a=arguments[t];for(var i in a)a.hasOwnProperty(i)&&(e[i]=a[i])}return e},appendInItsOwnLine:function(e,t){return(e+"\n\n[[D]]"+t).replace(/(\n{2,})\[\[D\]\]/,"\n\n").replace(/^(\n*)/,"")},insertTextAtCursor:function(t,a){var i,n=t.scrollTop,r=0,o=!1;t.selectionStart||"0"===t.selectionStart?o="ff":e.selection&&(o="ie"),"ie"===o?(t.focus(),i=e.selection.createRange(),i.moveStart("character",-t.value.length),r=i.text.length):"ff"===o&&(r=t.selectionStart);var s=t.value.substring(0,r),l=t.value.substring(r,t.value.length);t.value=s+a+l,r+=a.length,"ie"===o?(t.focus(),i=e.selection.createRange(),i.moveStart("character",-t.value.length),i.moveStart("character",r),i.moveEnd("character",0),i.select()):"ff"===o&&(t.selectionStart=r,t.selectionEnd=r,t.focus()),t.scrollTop=n}},a.defaults={uploadUrl:"upload_attachment.php",uploadMethod:"POST",uploadFieldName:"file",defaultExtension:"png",jsonFieldName:"filename",allowedTypes:["image/jpeg","image/png","image/jpg","image/gif"],progressText:"![Uploading file...]()",urlText:"![file]({filename})",errorText:"Error uploading file",extraParams:{},extraHeaders:{},beforeFileUpload:function(){return!0},onFileReceived:function(){},onFileUploadResponse:function(){return!0},onFileUploadError:function(){return!0},onFileUploaded:function(){}},a.prototype.uploadFile=function(e){var t=this,a=new FormData,i=new XMLHttpRequest,n=this.settings,r=n.defaultExtension||n.defualtExtension;if("function"==typeof n.setupFormData&&n.setupFormData(a,e),e.name){var o=e.name.match(/\.(.+)$/);o&&(r=o[1])}var s="image-"+Date.now()+"."+r;if("function"==typeof n.remoteFilename&&(s=n.remoteFilename(e)),a.append(n.uploadFieldName,e,s),"object"==typeof n.extraParams)for(var l in n.extraParams)n.extraParams.hasOwnProperty(l)&&a.append(l,n.extraParams[l]);if(i.open("POST",n.uploadUrl),"object"==typeof n.extraHeaders)for(var p in n.extraHeaders)n.extraHeaders.hasOwnProperty(p)&&i.setRequestHeader(p,n.extraHeaders[p]);return i.onload=function(){200===i.status||201===i.status?t.onFileUploadResponse(i):t.onFileUploadError(i)},!1!==n.beforeFileUpload(i)&&i.send(a),i},a.prototype.isFileAllowed=function(e){return"string"!==e.kind&&(0===this.settings.allowedTypes.indexOf("*")||this.settings.allowedTypes.indexOf(e.type)>=0)},a.prototype.onFileUploadResponse=function(e){if(!1!==this.settings.onFileUploadResponse.call(this,e)){var t=JSON.parse(e.responseText),a=t[this.settings.jsonFieldName];if(t&&a){var i;i="function"==typeof this.settings.urlText?this.settings.urlText.call(this,a,t):this.settings.urlText.replace(this.filenameTag,a);var n=this.editor.getValue().replace(this.lastValue,i);this.editor.setValue(n),this.settings.onFileUploaded.call(this,a)}}},a.prototype.onFileUploadError=function(e){if(!1!==this.settings.onFileUploadError.call(this,e)){var t=this.editor.getValue().replace(this.lastValue,"");this.editor.setValue(t)}},a.prototype.onFileInserted=function(e){!1!==this.settings.onFileReceived.call(this,e)&&(this.lastValue=this.settings.progressText,this.editor.insertValue(this.lastValue))},a.prototype.onPaste=function(e){var t,a=!1,i=e.clipboardData;if("object"==typeof i){t=i.items||i.files||[];for(var n=0;n<t.length;n++){var r=t[n];this.isFileAllowed(r)&&(a=!0,this.onFileInserted(r.getAsFile()),this.uploadFile(r.getAsFile()))}}return a&&e.preventDefault(),a},a.prototype.onDrop=function(e){for(var t=!1,a=0;a<e.dataTransfer.files.length;a++){var i=e.dataTransfer.files[a];this.isFileAllowed(i)&&(t=!0,this.onFileInserted(i),this.uploadFile(i))}return t},t.inlineAttachment=a}(document,window);